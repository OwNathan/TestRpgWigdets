<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party Reputation Widget</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Orbitron for headers, Share Tech Mono for data -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff00ff;
            --bg-dark: #050505;
            --bg-panel: #0a0f14;
        }

        html, body {
            height: 100%; /* Ensure full height is available */
        }

        body {
            background-color: transparent;
            font-family: 'Share Tech Mono', monospace;
            color: var(--neon-cyan);
            /* Removed overflow:hidden to allow scrolling if embed is too small */
            overflow-y: auto; 
            overflow-x: hidden;
        }

        /* Cyberpunk Card Container */
        .cyber-card {
            background-color: var(--bg-panel);
            border: 1px solid rgba(0, 243, 255, 0.3);
            position: relative;
            clip-path: polygon(
                0 10px, 
                10px 0, 
                100% 0, 
                100% calc(100% - 10px), 
                calc(100% - 10px) 100%, 
                0 100%
            );
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
        }

        /* Scanline effect overlay */
        .scanlines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
            opacity: 0.3;
        }

        /* Segmented Bar Styling */
        .segment {
            height: 100%;
            transform: skewX(-20deg);
            border: 1px solid rgba(0, 243, 255, 0.2);
            background: rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            opacity: 0.3;
        }

        /* Active Positive Segment (Right side) */
        .segment.active-pos {
            background: var(--neon-cyan);
            box-shadow: 0 0 8px var(--neon-cyan);
            border-color: #fff;
            opacity: 1;
        }

        /* Active Negative Segment (Left side) */
        .segment.active-neg {
            background: var(--neon-pink);
            box-shadow: 0 0 10px var(--neon-pink);
            border-color: #fff;
            opacity: 1;
        }

        /* Center divider */
        .center-divider {
            width: 4px;
            height: 120%;
            background-color: #333;
            margin: 0 4px;
            transform: skewX(-20deg);
            z-index: 30;
        }

        /* Glitch Text */
        .glitch-text {
            font-family: 'Orbitron', sans-serif;
            text-shadow: 1px 0 var(--neon-pink), -1px 0 var(--neon-cyan);
            white-space: nowrap; /* Prevent wrapping for resize logic */
        }
    </style>
</head>
<!-- Removed min-h-screen and items-center to prevent vertical centering clipping issues -->
<body class="flex justify-center bg-black p-2 sm:p-4">

    <!-- Widget Container -->
    <!-- Added responsive padding (p-3 on mobile, p-6 on desktop) -->
    <div class="cyber-card w-full max-w-md p-3 sm:p-6 relative my-auto">
        <div class="scanlines"></div>
        
        <!-- Header -->
        <div class="flex justify-between items-end mb-1 sm:mb-2 border-b border-cyan-900 pb-1 sm:pb-2 relative z-20">
            <div class="flex-grow overflow-hidden mr-2 sm:mr-4">
                <!-- Responsive text sizes -->
                <h2 class="text-[10px] sm:text-xs text-cyan-700 tracking-widest mb-1">DATA_STREAM // <span id="data-id">LOADING...</span></h2>
                <!-- Faction Name Container: Responsive height -->
                <div class="h-6 sm:h-8 flex items-end w-full overflow-hidden">
                    <h1 class="text-xl sm:text-2xl font-bold tracking-wider text-white glitch-text uppercase" id="faction-name">
                        CONNECTING...
                    </h1>
                </div>
            </div>
            <div class="text-right flex-shrink-0">
                <div class="text-[10px] sm:text-xs text-pink-500 font-bold tracking-widest uppercase">PARTY_REP</div>
                <!-- Responsive Score Size -->
                <div class="text-2xl sm:text-3xl font-bold" id="numeric-display">--</div>
            </div>
        </div>

        <!-- The Split Bar (-5 to +5) -->
        <!-- Responsive height and margin -->
        <div class="h-6 sm:h-8 w-full flex items-center justify-center my-2 sm:my-4 px-1 relative z-20 overflow-hidden">
            
            <!-- Negative Side (Right aligned inside left box to grow from center) -->
            <div class="flex-1 flex justify-end space-x-1 space-x-reverse h-full" id="bar-neg-container">
                <!-- Injected via JS -->
            </div>

            <!-- Center Marker -->
            <div class="center-divider"></div>

            <!-- Positive Side (Left aligned inside right box to grow from center) -->
            <div class="flex-1 flex justify-start space-x-1 h-full" id="bar-pos-container">
                <!-- Injected via JS -->
            </div>

        </div>

        <!-- Footer / Description -->
        <div class="flex justify-between items-center mt-1 sm:mt-2 text-[10px] sm:text-xs relative z-20 min-h-[1.5em]">
            <div class="text-cyan-300 font-bold uppercase tracking-wide w-full truncate" id="desc-text">
                ESTABLISHING LINK...
            </div>
        </div>
        
        <!-- Decorative corner bits: Responsive sizing -->
        <div class="absolute top-0 right-0 w-4 h-4 sm:w-8 sm:h-8 border-t-2 border-r-2 border-cyan-500 opacity-50"></div>
        <div class="absolute bottom-0 left-0 w-4 h-4 sm:w-8 sm:h-8 border-b-2 border-l-2 border-pink-500 opacity-50"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SHEET_ID = '1V2KganEwaOUCPIvh8_iQTfsgf4uNXFUx_13xTtSFxxI';
        const SHEET_GID = '0';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

        // Get Row from URL (default to 4 as requested, usually row 4 is index 3)
        const urlParams = new URLSearchParams(window.location.search);
        // Note: Arrays are 0-indexed, but Sheets are 1-indexed. 
        const TARGET_ROW_INDEX = (parseInt(urlParams.get('row')) || 4) - 1; 

        // DOM Elements
        const elFactionName = document.getElementById('faction-name');
        const elNumeric = document.getElementById('numeric-display');
        const elDesc = document.getElementById('desc-text');
        const elDataId = document.getElementById('data-id');
        const elBarPos = document.getElementById('bar-pos-container');
        const elBarNeg = document.getElementById('bar-neg-container');

        // --- FETCH DATA ---
        async function init() {
            try {
                const response = await fetch(CSV_URL);
                const text = await response.text();
                const rows = parseCSV(text);

                if (rows.length > TARGET_ROW_INDEX) {
                    const rowData = rows[TARGET_ROW_INDEX];
                    // Expecting: [Name, RepValue, Description]
                    const name = rowData[0] || "UNKNOWN";
                    const rep = parseInt(rowData[1]) || 0;
                    const desc = rowData[2] || "NO DATA";

                    updateUI(name, rep, desc);
                } else {
                    updateUI("ERROR", 0, "ROW NOT FOUND");
                }
            } catch (err) {
                console.error(err);
                // Fallback for preview if fetch is blocked
                // Simulating Row 4 (generic example) for preview
                updateUI("MAELSTROM", 2, "UNPREDICTABLE // DANGER");
            }
        }

        // --- UI UPDATER ---
        function updateUI(name, rep, desc) {
            // 1. Set Text
            elFactionName.innerText = name;
            elNumeric.innerText = (rep > 0 ? "+" : "") + rep; // Add + sign for positive
            elDesc.innerText = desc;
            
            // Hex ID flavor text
            elDataId.innerText = "0x" + (name.length * 123).toString(16).toUpperCase();

            // 2. Resize Name if too long
            resizeTextToFit(elFactionName);

            // 3. Render Bar
            renderBiDirectionalBar(rep);
        }

        // --- BAR RENDERER (-5 to +5) ---
        function renderBiDirectionalBar(rep) {
            elBarPos.innerHTML = '';
            elBarNeg.innerHTML = '';

            const MAX_SCORE = 5;
            const clampedRep = Math.max(-5, Math.min(5, rep));

            // Create 5 segments for NEGATIVE side (Right to Left visually)
            // Negative Loop: 5 down to 1
            for (let i = 5; i >= 1; i--) {
                const seg = document.createElement('div');
                seg.className = 'segment w-full';
                if (clampedRep < 0 && i <= Math.abs(clampedRep)) {
                    seg.classList.add('active-neg');
                    seg.style.boxShadow = `0 0 ${10 + i*2}px var(--neon-pink)`; // Increasing glow
                }
                elBarNeg.appendChild(seg);
            }

            // Positive Loop: 1 up to 5
            for (let i = 1; i <= 5; i++) {
                const seg = document.createElement('div');
                seg.className = 'segment w-full';
                if (clampedRep > 0 && i <= clampedRep) {
                    seg.classList.add('active-pos');
                    seg.style.boxShadow = `0 0 ${10 + i*2}px var(--neon-cyan)`;
                }
                elBarPos.appendChild(seg);
            }
        }

        // --- HELPERS ---
        
        // Simple CSV parser
        function parseCSV(str) {
            const arr = [];
            let quote = false;
            let col, c;

            for (let row = col = c = 0; c < str.length; c++) {
                let cc = str[c], nc = str[c+1];
                arr[row] = arr[row] || [];
                arr[row][col] = arr[row][col] || '';

                if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; }
                else if (cc == '"') { quote = !quote; }
                else if (cc == ',' && !quote) { ++col; }
                else if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; }
                else if (cc == '\n' && !quote) { ++row; col = 0; }
                else { arr[row][col] += cc; }
            }
            return arr;
        }

        // Text Resizer
        function resizeTextToFit(el) {
            // Responsive Max Size: 1.25rem on mobile, 1.5rem on larger screens
            const maxFontSize = window.innerWidth < 640 ? 1.25 : 1.5;
            
            let fontSize = maxFontSize; 
            el.style.fontSize = fontSize + 'rem';
            const parent = el.parentElement;
            
            // Reduce until it fits or gets too small
            // We check scrollWidth (content) vs clientWidth (visible box)
            while (el.scrollWidth > parent.clientWidth && fontSize > 0.5) {
                fontSize -= 0.1;
                el.style.fontSize = fontSize + 'rem';
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
