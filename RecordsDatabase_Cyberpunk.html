<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clue & News Database</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Orbitron for headers, Share Tech Mono for data -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-yellow: #fcee0a;
            --bg-dark: #050505;
            --bg-panel: #0a0f14;
        }

        html, body {
            min-height: 100%;
            height: auto;
        }

        body {
            background-color: transparent;
            font-family: 'Share Tech Mono', monospace;
            color: var(--neon-cyan);
            overflow-y: visible;
            overflow-x: hidden;
        }

        /* --- Main App Container (The "Screen") --- */
        .cyber-card {
            background-color: var(--bg-panel);
            border: 1px solid rgba(0, 243, 255, 0.3);
            position: relative;
            /* Angled corners: Top-Left and Bottom-Right cut */
            clip-path: polygon(
                20px 0, 
                100% 0, 
                100% calc(100% - 20px), 
                calc(100% - 20px) 100%, 
                0 100%, 
                0 20px
            );
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.05);
        }

        /* Scanline Overlay */
        .scanlines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.2) 50%,
                rgba(0,0,0,0.2)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 50;
            opacity: 0.15;
        }

        /* Glitch Text Effect */
        .glitch-text {
            font-family: 'Orbitron', sans-serif;
            text-shadow: 2px 0 var(--neon-pink), -2px 0 var(--neon-cyan);
        }

        /* --- Individual Clue Item Styling --- */
        .clue-item {
            background: rgba(5, 10, 15, 0.85); /* Darker, more opaque background for readability */
            border: 1px solid rgba(0, 243, 255, 0.2); /* Thin technical border */
            position: relative;
            /* Technical Shape: Cut bottom-right corner */
            clip-path: polygon(
                0 0, 
                100% 0, 
                100% calc(100% - 15px), 
                calc(100% - 15px) 100%, 
                0 100%
            );
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        /* Top Accent Line */
        .clue-item::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: var(--neon-cyan);
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        
        .clue-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 243, 255, 0.1);
            border-color: rgba(0, 243, 255, 0.5);
        }

        .clue-item:hover::before {
            opacity: 1;
            box-shadow: 0 0 8px var(--neon-cyan);
        }

        /* Inner technical text styling */
        .tech-label {
            color: rgba(0, 243, 255, 0.6);
            font-size: 0.65rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .clue-item:hover {
            background: rgba(0, 243, 255, 0.05);
            /* Hover effect is now a full glow instead of a color shift */
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.15);
            border-top-color: #fff;
            transform: translateY(-2px);
        }

        /* Decorative "Corner" for Clue Items */
        .clue-corner {
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 20px 20px 0;
            border-color: transparent var(--neon-cyan) transparent transparent;
            opacity: 0.5;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #000; 
        }
        ::-webkit-scrollbar-thumb {
            background: #00f3ff; 
            border-radius: 3px;
        }
    </style>
</head>
<body class="flex justify-center bg-transparent p-2 sm:p-4">

    <!-- Main Widget Container -->
    <!-- 'w-full' allows it to fill the iframe width -->
    <div class="cyber-card w-full p-4 sm:p-6 relative mb-8 min-h-[300px]">
        <div class="scanlines"></div>
        
        <!-- --- HEADER SECTION --- -->
        <div class="flex justify-between items-end border-b border-cyan-900/50 pb-2 mb-6 relative z-20">
            <div>
                <h2 class="text-xs text-cyan-700 tracking-[0.3em] mb-1">ARCHIVE_ACCESS // V.4.0.1</h2>
                <h1 class="text-2xl sm:text-3xl font-black tracking-wider text-white glitch-text uppercase">
                    RECORDED_ENTRIES
                </h1>
            </div>
            <!-- Decorative Status Light -->
            <div class="flex items-center space-x-2 border border-cyan-900/30 px-3 py-1 bg-black/40">
                <span class="text-[10px] text-cyan-600 font-bold tracking-widest">LOADING_COMPLETE</span>
                <div class="w-1.5 h-1.5 bg-cyan-500 shadow-[0_0_8px_#00f3ff]"></div>
            </div>
        </div>

        <!-- --- GRID CONTAINER --- -->
        <!-- 
            Grid Logic:
            - 1 column on mobile (grid-cols-1)
            - 2 columns on small tablets (sm:grid-cols-2)
            - 3 columns on desktops (lg:grid-cols-3)
        -->
        <div id="clue-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 relative z-20">
            <!-- Entries injected here -->
            <div class="col-span-full text-center animate-pulse text-cyan-500 mt-8 font-orbitron">
                DECRYPTING DATA STREAM...
            </div>
        </div>
        
        <!-- Bottom Decoration -->
        <div class="absolute bottom-2 right-4 text-[10px] text-cyan-800 font-mono z-20">
            SECURE_CONNECTION_ESTABLISHED
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        
        // 1. Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        
        // 2. Define Defaults
        const DEFAULT_SHEET_ID = '1qmfeFxPeAmccrxF7qggzWwpNchkpsw6wsTco-2cvRXw';
        
        // 3. Determine Settings
        const SHEET_ID = urlParams.get('sheetId') || DEFAULT_SHEET_ID;
        // Hardcoded to 'Clues' as requested
        const SHEET_NAME = 'Clues'; 
        
        // 4. API Endpoint
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

        // DOM Elements
        const gridContainer = document.getElementById('clue-grid');

        // --- FETCH & INIT ---
        async function init() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const text = await response.text();
                const rows = parseCSV(text);

                // Clear loading text
                gridContainer.innerHTML = '';

                // Loop through rows (Skip header row 0)
                for (let i = 1; i < rows.length; i++) {
                    const rowData = rows[i];
                    // Basic validation: ensure we have at least a title
                    if (!rowData || rowData.length < 1 || !rowData[0]) continue;

                    const data = {
                        name: rowData[0] || "UNIDENTIFIED",
                        date: rowData[1] || "N/A",
                        place: rowData[2] || "UNKNOWN LOCATION",
                        desc: rowData[3] || "No data available."
                    };

                    // Pass index 'i' to generate an ID
                    createCard(data, i);
                }

            } catch (err) {
                console.error(err);
                gridContainer.innerHTML = `
                    <div class="col-span-full border border-red-900 bg-red-900/20 p-4 text-center">
                        <h3 class="text-red-500 font-bold mb-2">CONNECTION FAILURE</h3>
                        <p class="text-xs text-gray-400">Could not retrieve intel from: ${SHEET_NAME}</p>
                        <p class="text-[10px] text-gray-600 mt-2 font-mono">${err.message}</p>
                    </div>
                `;
            }
        }

        // --- RENDER COMPONENT ---
        function createCard(data, index) {
            // Card Wrapper
            const card = document.createElement('div');
            card.className = 'clue-item h-full group';

            // 1. Technical Header Bar
            const headerBar = document.createElement('div');
            headerBar.className = 'bg-cyan-900/10 border-b border-cyan-500/20 p-2 flex justify-between items-center';
            
            // Record ID
            const idSpan = document.createElement('span');
            idSpan.className = 'font-mono text-[10px] text-cyan-600';
            idSpan.innerText = `#REC_${String(index).padStart(3, '0')}`;
            
            // Date (moved to header)
            const dateSpan = document.createElement('span');
            dateSpan.className = 'font-mono text-[10px] text-pink-400 opacity-80';
            dateSpan.innerText = data.date;

            headerBar.appendChild(idSpan);
            headerBar.appendChild(dateSpan);
            card.appendChild(headerBar);

            // 2. Main Body Content
            const contentDiv = document.createElement('div');
            contentDiv.className = 'p-4 flex flex-col flex-grow';

            // Title
            const title = document.createElement('h3');
            title.className = 'font-orbitron font-bold text-lg text-white tracking-wide mb-3 leading-tight group-hover:text-cyan-200 transition-colors';
            title.innerText = data.name;
            contentDiv.appendChild(title);

            // Description
            const desc = document.createElement('div');
            desc.className = 'text-sm text-gray-400 leading-relaxed font-mono opacity-90 flex-grow whitespace-pre-wrap border-l border-cyan-900/50 pl-3';
            // CHANGED: Use innerHTML with our formatter instead of innerText
            desc.innerHTML = formatText(data.desc);
            contentDiv.appendChild(desc);

            card.appendChild(contentDiv);

            // 3. Technical Footer (Location)
            const footer = document.createElement('div');
            footer.className = 'px-4 pb-3 pt-0 mt-auto';
            
            const placeContainer = document.createElement('div');
            placeContainer.className = 'flex items-center justify-end border-t border-cyan-900/30 pt-2';
            
            const placeLabel = document.createElement('span');
            placeLabel.className = 'tech-label mr-2';
            placeLabel.innerText = "LOC //";
            
            const placeVal = document.createElement('span');
            placeVal.className = 'text-xs text-gray-300 font-mono truncate max-w-[150px]';
            placeVal.innerText = data.place;

            placeContainer.appendChild(placeLabel);
            placeContainer.appendChild(placeVal);
            footer.appendChild(placeContainer);
            card.appendChild(footer);

            // Append to Grid
            gridContainer.appendChild(card);
        }

        // --- PARSER HELPERS ---
        // Robust CSV parser handles quoted strings with commas inside
        function parseCSV(str) {
            const arr = [];
            let quote = false;
            let col, c;
            for (let row = col = c = 0; c < str.length; c++) {
                let cc = str[c], nc = str[c+1];
                arr[row] = arr[row] || [];
                arr[row][col] = arr[row][col] || '';
                if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; }
                else if (cc == '"') { quote = !quote; }
                else if (cc == ',' && !quote) { ++col; }
                else if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; }
                else if (cc == '\n' && !quote) { ++row; col = 0; }
                else { arr[row][col] += cc; }
            }
            return arr;
        }

        // --- TEXT FORMATTING HELPER ---
        // basic markdown support for **bold** and *italic*
        function formatText(text) {
            if (!text) return "";
            
            // 1. Escape HTML (prevent injection of actual HTML tags from user)
            let formatted = text.replace(/&/g, "&amp;")
                                .replace(/</g, "&lt;")
                                .replace(/>/g, "&gt;");

            // 2. Parse Markdown
            // Bold: **text** or __text__
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong class="text-cyan-100">$1</strong>');
            formatted = formatted.replace(/__(.*?)__/g, '<strong class="text-cyan-100">$1</strong>');
            
            // Italic: *text* or _text_
            formatted = formatted.replace(/\*(.*?)\*/g, '<em class="text-pink-200">$1</em>');
            formatted = formatted.replace(/_(.*?)_/g, '<em class="text-pink-200">$1</em>');

            return formatted;
        }

        // Init
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
